name: Merge CFNat and CFST IPs
on:
  push:
    branches: [main]
    paths:
      - 'cfnat.txt'
      - 'cfst_ips.txt'
      - 'txyx.txt'
  workflow_dispatch:
    inputs:
      files:
        description: 'Space-separated source files to merge, in order (e.g. "cfnat.txt cfst_ips.txt")'
        required: false
        default: 'cfnat.txt cfst_ips.txt txyx.txt'

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge specified source files into yxURL.txt
        run: |
          set -euo pipefail

          DST="yxURL.txt"
          # 如果文件在 default 目录下，需要添加路径前缀
          FILES="${{ github.event.inputs.files }}"

          IFS=' ' read -r -a SRCS <<< "$FILES"

          if [ "${#SRCS[@]}" -eq 0 ]; then
            echo "No source files specified; nothing to do."
            exit 0
          fi

          ARGS=()
          for f in "${SRCS[@]}"; do
            if [ -z "$f" ]; then
              continue
            fi
            # 如果文件在 default 目录下，使用完整路径
            FILE_PATH="default/$f"
            if [ ! -f "$FILE_PATH" ]; then
              echo "Warning: source file '$FILE_PATH' not found — creating empty file."
              mkdir -p default
              touch "$FILE_PATH"
            fi
            ARGS+=("$FILE_PATH")
          done

          TMP="$(mktemp)"
          awk 'NF && !seen[$0]++ {print}' "${ARGS[@]}" > "$TMP"

          if [ -s "$TMP" ]; then
            tail -c1 "$TMP" | od -An -t u1 | tr -d ' ' | grep -q '^10$' || echo >> "$TMP"
          fi

          # 确保输出文件也在 default 目录
          OUTPUT="default/$DST"
          if [ ! -f "$OUTPUT" ] || ! cmp -s "$TMP" "$OUTPUT"; then
            mv "$TMP" "$OUTPUT"
            echo "Merged content written to $OUTPUT"
            CHANGED=1
          else
            rm -f "$TMP"
            echo "No changes detected; nothing to commit."
            CHANGED=0
          fi

      - name: Commit and push changes
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add default/yxURL.txt || true
          if ! git diff --staged --quiet; then
            git commit -m "Update yxURL.txt with merged content"
            git push
          else
            echo "No changes to commit"
          fi
