name: Merge CFNat and CFST IPs

on:
  push:
    branches: [main]
    paths:
      - 'cfnat.txt'
      - 'cfst_ips.txt'
      - 'txyx.txt'
  workflow_dispatch:
    inputs:
      files:
        description: 'Space-separated source files (uses default list if empty)'
        required: false
        default: 'cfnat.txt cfst_ips.txt txyx.txt'

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Merge files into yxURL.txt
        run: |
          set -euo pipefail

          DST="yxURL.txt"
          # 获取文件列表：手动输入优先，否则使用默认值
          FILES="${{ github.event.inputs.files }}"
          if [ -z "$FILES" ]; then
            # push 事件触发时，自动过滤只保留存在的文件
            FILES=""
            for f in cfnat.txt cfst_ips.txt txyx.txt; do
              [ -f "$f" ] && FILES="$FILES $f"
            done
          fi

          IFS=' ' read -r -a SRCS <<< "$FILES"
          
          if [ "${#SRCS[@]}" -eq 0 ]; then
            echo "No source files to process"
            exit 0
          fi

          ARGS=()
          for f in "${SRCS[@]}"; do
            [ -z "$f" ] && continue
            if [ ! -f "$f" ]; then
              echo "Warning: '$f' not found — creating empty file"
              touch "$f"
            fi
            ARGS+=("$f")
          done

          TMP="$(mktemp)"
          awk 'NF && !seen[$0]++ {print}' "${ARGS[@]}" > "$TMP"

          [ -s "$TMP" ] && tail -c1 "$TMP" | od -An -t u1 | tr -d ' ' | grep -q '^10$' || echo >> "$TMP"

          if [ ! -f "$DST" ] || ! cmp -s "$TMP" "$DST"; then
            mv "$TMP" "$DST"
            echo "Merged content written to $DST"
          else
            rm -f "$TMP"
            echo "No changes detected"
          fi

      - name: Commit and push changes
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add yxURL.txt || true
          if ! git diff --staged --quiet; then
            git commit -m "Update yxURL.txt with merged content"
            git push
          else
            echo "No changes to commit"
          fi
